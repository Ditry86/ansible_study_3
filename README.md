# README к Домашнему заданию по занятию "7.3. Основы и принцип работы Терраформ".

Данный репозиторий содержит практическое решение для задания по занятию "7.3. Основы и принцип работы Терраформ". 

В ходе реализации проекта в облаке Yandex создаются: VPC; 3 виртуальные машины (ВМ) с сервисами Clickhouse, Vector, Lighthouse; подсеть 192.168.10.0/24.

## Содержание репозитория
---

1. Каталог `terraform`. Структура файлов terraform для создания ВМ и соответствующего окружения в облаке Yandex:
  - Файл описания создаваемых инстансов (ВМ) - `instances.tf`;
  - Файл описания переменных (входные, выходные) - `vars.tf`;
  - Файл поисания VPC - `vpc.tf`;
  - Файл описания провайдера, облачного образа установки ОС - `version.tf`.
2. Каталог `playbook`. Структура файлов ansible для настройки ВМ и установки ПО на них:
  - Основной файл playbook - `site.yml`;
  - Директория `inventory` с файлом описания рабочей инфраструктуры - `prod.yml`;
  - Директория `group_vars` с файлами описания переменных для груп хостов: clickhouse, vector, lighthouse;
  - Директория templates с файлами щаблонов конфигураций ПО для хостов: nginx, vector;
3. Каталог auto. Файлы bash-скриптов для автоматизации выполнения операций по реализации задач проекта:
  - install_env_app.sh - скрипт проверки и установки неоходимого ПО на вашем ПК (control-node);
  - init_cloud.sh - скрипт настройки утилиты yc, инициализации подключения к облаку, создания сервисного аккаунта для работы с облаком;
  - tf_provider_mirror.sh - скрипт замены конфигурации провайдера yandex для terraform (установка провайлера с зеркала yandex);
  - yc_env_var.sh - скрипт добавления переменных окружения текущей облочки терминала для настройки и конфигурации работы утилиты yc;
  - get_ip - скрипт считывания и записи во временные файлы (local_ip, ext_ip) информации об ip-адресах созданных вМ из переменных tf_output;
  - ip_env_var - скрипт добавления переменных окружения текущей облочки терминала для хранения информации об ip-адресах созданных ВМ.
4. Корневой каталог так же содержит:
  - make-файл;
  - файл конфигурации для автоматизации шагов по решению заданий проекта.

## Описание проекта
---

Для выполнения задания необходимо развернуть три ВМ в Yandex Cloud. В данном проекте создание инфрастуктуры в облаке осуществляется с помощью terraform. Установка и настройка необходимого программного обеспечения производится с помощью ansible playbook.

### 

** Основные параметры для каждой ВМ проекта: **
CPU - 2 ядра,
RAM - 4 ГБ,
Disk - 20 ГБ,
Два сетевых интерфейса:
  - локальный, подсеть - 192.168.10.0/24 (IP-адрес присваивается авьлмаически)
  - внешний (присваевается автоматически)
Образ операционной системы - Centos 7 (YC Image)

Для начала работы необходимо инициализировать подключение к вашему облаку на Yandex Cloud с соответствующими настройками. Затем произвести инициализацию terraform и развернуть необходимое окружение в облаке через ```terraform plan && terraform apply```. после произвести установку и настройку ПО на созданных ВМ при помощи ```ansible-playbook site.yml -i inventory/prod.yml```.

Произвести вышеописанные действия можно вручную, либо через bash-скрипты, при помощи make-файла (см. ниже). 
>**Важно!** bash-скрипты, запускаемые через make-файл, созданы и протестированы для Centos (версии 7,8), Ubuntu (версии 20.04 и выше).


## Сценарии (комманды), осуществляемые через make
---

**1. Установка необходимого ПО на вашем ПК (control node)**

Команда установки:

```
make install
```
Скрипт проверяет наличие установленного нобходимого ПО на ПК, устонавливает отсутствующее.
После отработки скрипта необходимо выполнить ``` source ~/.bashrc ``` для инициализации установленного ПО в оболочке вашей сессии терминала в системе, либо перезагрузить терминал.

## 2. Подготовка вашего облака Yandex и переменных окружения на вашем ПК

Для работы скриптов на данном шаге реализации проекта, необходимо в корневом каталоге проекта создать и заполнить файл конфигурации проекта - `init.conf` (пример находится в корне проекта под именем `init.conf.example`). В самом файле перечислены все необходимые для работы с облаком Yandex переменные: личный токен для подключения к API облака, clour_id, folder_id, зона облака для развертки инстансов, имя для сервисного аккаунта.
Комманда подготовки:

    make prepare.

Скрипты производят настройку облака при помощи yc (yandex CLI) на основе указанных переменных в файле `init.conf`. А так же прописывают переменные окружения для работы terraform, производят изменение конфигурационных файлов terraform для устаноки провайдера yandex cloud с зеркала yandex, и проводит инициализацию самого terraform для вашего проекта (в каталоге terraform).

## 3. Развертка ВМ и окружения в облаке
Команда развертки:
    
    make deploy

Соответствует командам terraform: plan, apply. Осуществляет развертку облачной инфраструктуры для проекта: 3 ВМ (), VPC, локальная подсеть.

## 4. Запуск playbook

Команда запуска playbook:

    make ci

Производится, по необходимости, установка необходимых модулей python и ansible. Далее запускается playbook для inventory `prod`.

## 5. Удаление развернутого проекта

Команда удаления окружения:

    make destroy

Удаляются все созданные ВМ, подсети в облаке, а так же удаляются все произведенные настройки yc на вашем ПК (control node) и в облаке. Удаляются временные файлы проекта.