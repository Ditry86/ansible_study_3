# README к Домашнему заданию по занятию "7.3. Основы и принцип работы Терраформ".

Данный репозиторий содержит практическое решение для задания по занятию "7.3. Основы и принцип работы Терраформ". 

В ходе реализации проекта в облаке Yandex создаются: VPC; 3 виртуальные машины (ВМ) с сервисами Clickhouse, Vector, Lighthouse; подсеть 192.168.10.0/24.

## Содержание репозитория
---

1. Каталог `terraform`. Структура файлов terraform для создания ВМ и соответствующего окружения в облаке Yandex:
  - Файл описания создаваемых инстансов (ВМ) - `instances.tf`;
  - Файл описания переменных (входные, выходные) - `vars.tf`;
  - Файл поисания VPC - `vpc.tf`;
  - Файл описания провайдера, облачного образа установки ОС - `version.tf`.
2. Каталог `playbook`. Структура файлов ansible для настройки ВМ и установки ПО на них:
  - Основной файл playbook - `site.yml`;
  - Директория `inventory` с файлом описания рабочей инфраструктуры - `prod.yml`;
  - Директория `group_vars` с файлами описания переменных для груп хостов: clickhouse, vector, lighthouse;
  - Директория `templates` с файлами щаблонов конфигураций ПО для хостов: nginx, vector;
3. Каталог auto. Файлы bash-скриптов для автоматизации выполнения операций по реализации задач проекта:
  - `install_env_app.sh` - скрипт проверки и установки неоходимого ПО на вашем ПК (control-node);
  - `init_cloud.sh` - скрипт настройки утилиты yc, инициализации подключения к облаку, создания сервисного аккаунта для работы с облаком;
  - `tf_provider_mirror.sh` - скрипт замены конфигурации провайдера yandex для `terraform` (установка провайлера с зеркала yandex);
  - `yc_env_var.sh` - скрипт добавления переменных окружения текущей облочки терминала для настройки и конфигурации работы утилиты `yc`;
  - `get_ip.sh` - скрипт считывания и записи во временные файлы (`local_ip`, `ext_ip`) информации об ip-адресах созданных вМ из переменных `tf_output`;
  - `ip_env_var.sh` - скрипт добавления переменных окружения текущей облочки терминала для хранения информации об ip-адресах созданных ВМ.
4. Корневой каталог так же содержит:
  - `Makefile` - make-файл с инструкциями для запуска bash-скриптов и добавления env var's, необходимых для работы yc, terraform, ansible;
  - `init.conf.example` - файл-щаблон конфигурации для автоматизации шагов по решению заданий проекта;
  - `yandex_provider.example` - файл-шаблон конфигурации провайдера yandex для terraform.

## Описание проекта. 
---

Для выполнения задания необходимо развернуть три ВМ в Yandex Cloud. В данном проекте создание инфрастуктуры в облаке осуществляется с помощью terraform. Установка и настройка необходимого программного обеспечения производится с помощью ansible playbook.

### **Установка необходимого ПО на ваш ПК (control-node)**

Для загрузки проекта необходимо, чтобы на ОС вашего ПК стоял `git`. Перейдите в необходимый каталог вашей ОС и скопируйте проект с репозитория:

```
git clone http://github.com/ditry86/ansible_study_3.git
```

Для работы с облаком Yandex установите утилиту `yc` ([инструкция установки](https://cloud.yandex.ru/docs/cli/operations/install-cli))

Для создания ВМ в облаке и их настроек установите:
  - `terraform` ([инструкция установки](https://cloud.yandex.com/en-ru/docs/tutorials/infrastructure-management/terraform-quickstart#from-yc-mirror));
  - пакеты, необходимые для работы `ansible`: `python 3.6`, `pip`, `netaddr`;
  - `ansible` (установка либо через менеджер пакетов, либо через `pip`).

Так же для корректной работы ansible playbook может понадобится установить `ansible utils`:

```
ansible-galaxy collection install ansible.utils
```

### **Подгатовка к работе с облаком**

Для работы с облаком необходимо:
  1. Произвести настройки утилиты `yc`, инициализировать подключение к облаку ([см. инструкцию](https://cloud.yandex.ru/docs/cli/quickstart#initialize));
  2. Изменить конфигурацию провайдера terraform ([см. инструкцию](https://cloud.yandex.ru/docs/tutorials/infrastructure-management/terraform-quickstart#configure-provider)), инициализировать проект:
  ```
  cd terraform && terraform init
  ```
  
### **Создание ВМ и окружения в облаке**

Для реализации проекта в облаке с помощью `terraform` создаются три ВМ (Clickhouse-01, Vector-01, Lighthouse-01), VPC, локальная подсеть. Параметры каждой ВМ, локальной подсети указаны в локальных переменных, описанных в в файле `terraform/vars`:

```
locals {
    
    lans = {
        default = ["192.168.10.0/24"]
    }

    instances = { 
        "clickhouse" = {
            platform = "standard-v2",
            cores = 4,
            memory = 4
        },
        "vector" = {
            platform = "standard-v2",
            cores = 2,
            memory = 2
        },
        "lighthouse" = {
            platform = "standard-v1",
            cores = 2,
            memory = 2
        },
    }
}
```
Обрас ОС для развертывания ВМ в облаке - Centos 7 (yandex cloud image).

Для подключения к ВМ по ssh на основе образа от Yandex Cloud необходимо создать приватный и публичный ключ (который указан в описании создания ВМ в файле instances.tf):
```
ssh-keygen -t ed25519 -N ''
```

Для установки ВМ и окружения запустите:
```
terraform plan && terraform apply
``` 

При завершении работы `terraform` должен отобразить выходные переменные (описанные в файле vars.tf) с ip-адресами для каждой ВМ. 

### **Установка и настройка сервисов на ВМ**

Перед началом развертки сервисов на ВМ необходимо добавить в окружение текщей оболочки терминала переменные с ip-алресами ВМ. Это можно сделать через bashскрипты:
```
source get_ip.sh
source ip_env_var.sh
```
либо вручную
```
#!/usr/bin/env bash

export CLICKHOUSE_EXT_IP=$(cat ext_ip 2> /dev/null | grep clickhouse | sed 's/clickhouse[[:space:]]*//')
export VECTOR_EXT_IP=$(cat ext_ip 2> /dev/null | grep vector | sed 's/vector[[:space:]]*//')
export LIGHTHOUSE_EXT_IP=$(cat ext_ip 2> /dev/null | grep lighthouse | sed 's/lighthouse[[:space:]]*//')
export CLICKHOUSE_LOCAL_IP=$(cat local_ip 2> /dev/null | grep clickhouse | sed 's/clickhouse[[:space:]]*//')
export VECTOR_LOCAL_IP=$(cat local_ip 2> /dev/null | grep vector | sed 's/vector[[:space:]]*//')
export LIGHTHOUSE_LOCAL_IP=$(cat local_ip 2> /dev/null | grep lighthouse | sed 's/lighthouse[[:space:]]*//')
```
Так же необходимо отключить опцию ansible проверки ключей подключения к хостам через добавление переменной окружения:
```
export ANSIBLE_HOST_KEY_CHECKING=False
```

После можно произвести установку и настройку ПО на созданных ВМ:
```
ansible-playbook site.yml -i inventory/prod.yml
```

## Использование make-файла. 
---

Для удобства работы с проектом, вышеописанные сценарии работы с проектом можно произвести при помощи утилиты make.

>**Важно!** bash-скрипты, запускаемые через make-файл, созданы и протестированы для Centos (версии 7,8), Ubuntu (версии 20.04 и выше).

### **Сценарии (комманды), осуществляемые через make**:

**1. Установка необходимого ПО на вашем ПК (control node)**

Команда установки:

```
make install
```
Скрипт проверяет наличие установленного нобходимого ПО на ПК, устонавливает отсутствующее.
После отработки скрипта необходимо выполнить ``` source ~/.bashrc ``` для инициализации установленного ПО в оболочке вашей сессии терминала в системе, либо перезагрузить терминал.

**2. Подготовка вашего облака Yandex и переменных окружения на вашем ПК**

Для работы скриптов на данном шаге реализации проекта, необходимо в корневом каталоге проекта создать и заполнить файл конфигурации проекта - `init.conf` (пример находится в корне проекта под именем `init.conf.example`). В самом файле перечислены все необходимые для работы с облаком Yandex переменные: личный токен для подключения к API облака, clour_id, folder_id, зона облака для развертки инстансов, имя для сервисного аккаунта.
Комманда подготовки:

    make prepare.

Скрипты производят настройку облака при помощи yc (yandex CLI) на основе указанных переменных в файле `init.conf`. А так же прописывают переменные окружения для работы terraform, производят изменение конфигурационных файлов terraform для устаноки провайдера yandex cloud с зеркала yandex, и проводит инициализацию самого terraform для вашего проекта (в каталоге terraform).

**3. Развертка ВМ и окружения в облаке**
Команда развертки:
    
    make deploy

Соответствует командам terraform: plan, apply. Осуществляет развертку облачной инфраструктуры для проекта: 3 ВМ (), VPC, локальная подсеть.

**4. Запуск playbook**

Команда запуска playbook:

    make apps

Производится, по необходимости, установка необходимых модулей python и ansible. Далее запускается playbook для inventory `prod`.

**5. Удаление развернутого проекта**

Команда удаления окружения:

    make destroy

Удаляются все созданные ВМ, подсети в облаке, а так же удаляются все произведенные настройки yc на вашем ПК (control node) и в облаке. Удаляются временные файлы проекта.